<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Google Login & Raspberry Pi WSS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #eef2f3; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 450px; width: 90%; }
        h2 { color: #333; margin-bottom: 20px; }
        .btn-google { background: #4285F4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-logout { background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        #status { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; text-align: left; font-size: 13px; border: 1px solid #ddd; white-space: pre-wrap; }
        .success { color: #2e7d32; font-weight: bold; }
        .error { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>My Chat App (WSS Test)</h2>
    <div id="auth-ui">
        <button class="btn-google" onclick="signIn()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: åˆæœŸåŒ–ä¸­...</div>
</div>

<script>
    const SUPABASE_URL = 'https://cedpfdoanarzyxcroymc.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_E5jwgv5t2ONFKg3yFENQmw_lVUSFn4i';
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function signIn() {
        await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.href }
        });
    }

    async function signOut() {
        await supabaseClient.auth.signOut();
        location.reload();
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    async function init() {
        const statusDiv = document.getElementById('status');
        const authUi = document.getElementById('auth-ui');

        // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ï¼‰ã®å–å¾—
        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error) {
            statusDiv.innerHTML = `<span class="error">Authã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
            return;
        }

        if (session) {
            const user = session.user;
            statusDiv.innerHTML = `<span class="success">âœ… Supabaseãƒ­ã‚°ã‚¤ãƒ³ä¸­</span>\nName: ${user.user_metadata.full_name}\nUUID: ${user.id}\n\nWebSocketæ¥ç¶šã‚’è©¦è¡Œä¸­...`;
            authUi.innerHTML = `<button class="btn-logout" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`;

            // 2. ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã—ã¦ã„ãŸã‚‰WebSocketã‚’é–‹å§‹
            startWss(session, user);
        } else {
            statusDiv.innerText = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æœªãƒ­ã‚°ã‚¤ãƒ³';
        }
    }

    function startWss(session, user) {
        const statusDiv = document.getElementById('status');
        
        // ãƒ©ã‚ºãƒ‘ã‚¤ã®ã‚µãƒ¼ãƒãƒ¼ã¸æ¥ç¶š
        const socket = new WebSocket('wss://mail.shudo-physics.com');

        socket.onopen = () => {
            statusDiv.innerHTML += `\n<span class="success">âœ… WSSæ¥ç¶šæˆåŠŸ</span>`;
            
            // ã‚µãƒ¼ãƒãƒ¼ãŒå¾…ã£ã¦ã„ã‚‹ã€Œjoinã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
            const joinMsg = {
                type: "join",
                room: "test-room",
                name: user.user_metadata.full_name || "ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼",
                uuid: user.id,
                token: session.access_token // ãƒ©ã‚ºãƒ‘ã‚¤å´ã§æ¤œè¨¼ç”¨
            };
            
            socket.send(JSON.stringify(joinMsg));
            statusDiv.innerHTML += `\nèªè¨¼æƒ…å ±ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`;
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å—ä¿¡:", msg);
            statusDiv.innerHTML += `\nå—ä¿¡: ${msg.type}`;
            
            if (msg.type === "join-ack") {
                statusDiv.innerHTML += `\n<span class="success">ğŸš€ ã‚µãƒ¼ãƒãƒ¼èªè¨¼å®Œäº†ï¼æº–å‚™OK</span>`;
            }
        };

        socket.onclose = (e) => {
            statusDiv.innerHTML += `\n<span class="error">âŒ WSSåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ (Code: ${e.code})</span>`;
        };

        socket.onerror = (err) => {
            statusDiv.innerHTML += `\n<span class="error">âš ï¸ WSSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>`;
            console.error("WSS Error:", err);
        };
    }

    // èµ·å‹•
    init();
</script>

<a href="./dist/index.html">chat test</a>
</body>
</html>